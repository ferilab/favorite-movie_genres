---
title: "Most favorable movie genres based on users' ratings"
author: "Fereidoun Mianji"
date: "10/31/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

1. Introduction

Movielens database is generated by the GroupLens research lab2 from Netflix data. 
This database includes over 20 million ratings by more than 138,000 users for over 27,000 movies.
This dataset is too huge and its processing would be computationally too heavy, thus, a subset of
it consisting 100,000 ratings on 9066 movies by 671 users which is available in dslabs package is used here.

```{r required libs and saving the data, message=FALSE}
library(dslabs)
library(tidyverse)
library(lubridate)

movielens <- data("movielens") %>%
save(movielens, file = 'rdas/movielens.rda')
```

2. Years with enough rating frequency

The data depicts the information for every movie over time. We also can inspect movies statistics groups by their time of first appearance in the market (the year column). First we need to know which years are of enough number of ratings. Years that have less than few hundred ratings will be removed form the data.

```{r no of ratings vs first screening year, message=FALSE}
load('rdas/movielens.rda')
movielens %>% group_by(year) %>% summarise(n = n()) %>%
  ggplot(aes(year, n), scale_y_sqrt()) + geom_point() +
  ggtitle('Total number of ratings received by movies versus their first screening year') +
  xlab("The first screening year") +
  ylab('Total number of ratings') +
  ggsave('fig/ratings-per-year.png')
```

This plot shows that movies screened firstly before 1970 have a low total number of rating.
It worths to check out if the 25 most frequently rated movies (average annual number) are of the highest average rating too.

```{r , message=FALSE}
top25 <- movielens %>% filter(year >= 1970) %>% group_by(movieId) %>% 
  summarise(avg_rate = mean(rating), first_rating_year = min(year(as_datetime(timestamp))), 
            avg_annual_rated = n()/(2017 - first_rating_year)) %>%
  top_n(25, avg_annual_rated) 
```

According to the above table, being more frequently rated doesn't necessarily means that a movie has a top rating. 

3. Correlation of movies' rating and rating frequency

To explore the relation between the number of rating and the average rating in further detail, we stratify the post 1970 movies by average number of rating per year and then compute the average rating of the stratas. Plotting the average rating versus average number of annual rating shows that, except recently screened movies, the rating frequency is correlated with the average rating. As 2016 is the latest rating year in movielens, for averaging purposes 2017 is used in the formula as the ending year. Rating of the movies are recorded from 1995.

```{r calc. average ratings, message=FALSE}
post_1970 <- movielens %>% filter(year >= 1970) %>% group_by(movieId) %>% 
  summarise(avg_rate = mean(rating), first_rating_year = min(year(as_datetime(timestamp))), 
            avg_annual_rated = n()/(2017 - first_rating_year), list=FALSE) %>%
  mutate(rated_strata = round(avg_annual_rated, 0)) 

post_1970 %>%
  ggplot(aes(rated_strata, avg_rate)) + geom_point() + 
  geom_abline(intercept = 3, slope = 0.09, col = 'red') +
  ggtitle('Average rating versus average anual nuumber of rating') +
  xlab('Strata: the average number of annual ratings') +
  ylab('Average rate') +
  ggsave('fig/rating-vs-rating-No.png')
```

4. Rating chronoly

The movielens timestamp field represents the time and data in which the rating has been provided. The units are seconds since January 1, 1970. A new column date is added to represent the date in yyyy-mm-dd format. Then, the average rating for each week is calculated and plotted. The plot shows that the variability of ratings vs week of the year is very high and fuzzy, it doesn't follow any clear pattern.

```{r , message=FALSE}
movielens <- movielens %>% mutate(date = as_datetime(timestamp))
movielens %>% mutate(week = round_date(date, 'week')) %>% 
  group_by(week) %>% mutate(avg_rate = mean(rating)) %>% 
  select(week, avg_rate) %>% unique() %>%
  ggplot(aes(week, avg_rate)) + geom_point() +
  ggtitle('Average rating versus week') +
  xlab('Rating week') +
  ylab('Average rate') +
  ggsave('fig/rating-vs-week.png')
```

5. Genre ratings

The genre column includes every genre that applies to a movie. Most of movies fall under more than one genre. We define combined categories based on whatever combination the genre column represents. For the sake of statistical strength categories with less than 500 ratings are removed. The plot compares these hybrid categories in terms of the average and standard error.


```{r most favorite genres, message=FALSE}
movielens %>% group_by(genres) %>% 
  summarize(genres, avg_rate = mean(rating), upper = avg_rate + sd(rating)/sqrt(n()), 
            lower = avg_rate - sd(rating)/sqrt(n()))  %>%
  filter(n()>=500) %>% ggplot(aes(x = genres, ymin = lower, ymax = upper)) + 
  geom_errorbar() + geom_point(aes(genres, avg_rate)) + 
  ylab('Average rating of genres with their standard errors') +
  coord_flip() +
  ggsave('fig/rating-vs-genre.png')
```


As is shown, the highest rating by users belongs to comedy/drama/crime/thriller genre with about 4.2 and after that there are four other mixed genres with the average rating of 4. 
